<div id="map" style="height: 1024px;"></div>
<script>
var map;
var contourLayer = null;
var broadcasters = {};

var stringToColor = function(str) {

    // str to hash
    for (var i = 0, hash = 0; i < str.length; hash = str.charCodeAt(i++) + ((hash << 5) - hash));

    // int/hash to hex
    for (var i = 0, colour = "#"; i < 3; colour += ("00" + ((hash >> i++ * 8) & 0xFF).toString(16)).slice(-2));

    return colour;
}

function fetchBroadcasters() {
  $.getJSON("/broadcasters.json?bbox="+map.getBounds().toBBoxString()).done(function(data) {
    data.broadcaster_ids.forEach(function(id) {
      if (!broadcasters[id]) fetchBroadcaster(id);
    });
  });
}

function fetchBroadcaster(id) {
  $.getJSON("/broadcasters/"+id+".json").done(function(data) {
    if (!data.features.length) return;
    addContour(data.features);
    broadcasters[id] = data.features[0].properties;
  });
}

function addContour(featureCollection) {
  L.geoJson(featureCollection, {
    onEachFeature: function(feature, layer) {
      layer.bindPopup(feature.properties.summary);
    },
    
    style: function (feature) {
      return {
        color: feature.properties.color, //"#"+hex_md5(feature.properties.display_name).substring(0,6),
        weight: 10,
        opacity: 0.65,
      }
    }
  }).addTo(map);
}


$(document).ready(function() {
  map = L.map('map').setView([47.605237, -122.324638], 9);

  L.tileLayer('http://{s}.tile.cloudmade.com/{key}/22677/256/{z}/{x}/{y}.png', {
     attribution: 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade',
     key: '8ee2a50541944fb9bcedded5165f09d9'
  }).addTo(map);
  
  map.on('viewreset', fetchBroadcasters);
  map.on('moveend', fetchBroadcasters);
  map.on('resize', fetchBroadcasters);
  map.on('load', fetchBroadcasters);
  fetchBroadcasters();
});
</script>
